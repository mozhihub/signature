<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DYFI — E-Signature </title>
<link rel="shortcut icon" href="images/preview.jpg" type="image/svg+xml">
<meta property="og:title" content="DYFI Tnpsc Digital Signature Moment">
<meta property="og:description" content=" Dyfi - Tnpsc Digital Signature - DYFI Tamil Nadu">
<meta property="og:image" content="https://tndyfi.github.io/Signature/images/previews.png">
<meta property="og:url" content="https://tndyfi.github.io/Signature/">
<meta property="og:type" content="website">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://tndyfi.github.io/Signature/images/previews.png">

<script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-storage-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.js"></script> 

<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* (Existing CSS here - No changes needed) */
body{font-family:Inter,Arial,sans-serif;background:#f4f7f9;color:#111;margin:0;padding:18px;text-align:center}
.container{max-width:900px;margin:0 auto}
h2{margin:6px 0}
input,select{width:90%;max-width:420px;padding:12px;margin:8px 0;border-radius:8px;border:1px solid #ccc}
#box{width:95%;max-width:800px;height:50vh;border-radius:12px;border:2px solid #333;background:#fff;margin:12px auto;position:relative;overflow:hidden}
canvas{width:100%;height:100%;display:block}
.controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:12px 0}
button{padding:12px 18px;border-radius:8px;border:0;color:#fff;background:#1a73e8;cursor:pointer;font-weight:600}
button.danger{background:#d32f2f}
button.green{background:#0a8f08}
.counterRow{display:flex;gap:12px;justify-content:center;margin-top:10px}
.counter{background:#fff;padding:8px 12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.message-box{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);visibility:hidden;opacity:0;transition:opacity .2s}
.message-box.active{visibility:visible;opacity:1}
.message-content{background:#fff;padding:20px;border-radius:10px;max-width:320px;text-align:center}
.small{font-size:13px;color:#666}

/* small responsive tweaks */
@media (max-width:600px){
  input,select{width:94%}
  .controls{flex-direction:column;align-items:center}
}
</style>
</head>
<body>
<div class="container">
  <h2>DYFI நடத்தும் 1-லட்சம் TNPSC பணியிடங்களை நிரப்பக் கோரி கையெழுத்து இயக்கம் E-Signature </h2>
  <p class="small" id="tamil_petition_text"> தலை நிமிருமா 
தமிழக இளைஞர்களின் வாழ்வு.? 
சட்டமன்ற தேர்தலுக்கு முன் TNPSC தேர்வு மூலம் 1 இலட்சம் காலி பணியிடங்களை நிரப்பிடக்கோரி டிசம்பர் 1 தமிழ்நாடு முழுவதும் வேலை கேட்டு 
ஒரு நாள் காத்திருப்பு இயக்கம்! </p>

  <input id="name" placeholder="Enter Your Name" />
  <input id="number" placeholder="Enter Phone Number" type="tel" />

  <select id="district" required>
    <option value="" disabled selected>Choose Your District</option>
    <option value="Ariyalur">அரியலூர் - Ariyalur</option>
    <option value="Chengalpattu">செங்கல்பட்டு - Chengalpattu</option>
    <option value="Chennai">சென்னை - Chennai</option>
    <option value="Coimbatore">கோயம்புத்தூர் - Coimbatore</option>
    <option value="Cuddalore">கடலூர் - Cuddalore</option>
    <option value="Dharmapuri">தருமபுரி - Dharmapuri</option>
    <option value="Dindigul">திண்டுக்கல் - Dindigul</option>
    <option value="Erode">ஈரோடு - Erode</option>
    <option value="Kallakurichi">கள்ளக்குறிச்சி - Kallakurichi</option>
    <option value="Kancheepuram">காஞ்சிபுரம் - Kancheepuram</option>
    <option value="Kanyakumari">கன்னியாகுமரி - Kanyakumari</option>
    <option value="Karur">கரூர் - Karur</option>
    <option value="Krishnagiri">கிருஷ்ணகிரி - Krishnagiri</option>
    <option value="Madurai">மதுரை - Madurai</option>
    <option value="Mayiladuthurai">மயிலாடுதுறை - Mayiladuthurai</option>
    <option value="Nagapattinam">நாகப்பட்டினம் - Nagapattinam</option>
    <option value="Namakkal">நாமக்கல் - Namakkal</option>
    <option value="Nilgiris">நீலகிரி - Nilgiris</option>
    <option value="Perambalur">பெரம்பலூர் - Perambalur</option>
    <option value="Pudukkottai">புதுக்கோட்டை - Pudukkottai</option>
    <option value="Ramanathapuram">இராமநாதபுரம் - Ramanathapuram</option>
    <option value="Ranipet">இராணிப்பேட்டை - Ranipet</option>
    <option value="Salem">சேலம் - Salem</option>
    <option value="Sivaganga">சிவகங்கை - Sivaganga</option>
    <option value="Tenkasi">தென்காசி - Tenkasi</option>
    <option value="Thanjavur">தஞ்சாவூர் - Thanjavur</option>
    <option value="Theni">தேனி - Theni</option>
    <option value="Thoothukudi">தூத்துக்குடி - Thoothukudi</option>
    <option value="Tiruchirappalli">திருச்சிராப்பள்ளி - Tiruchirappalli</option>
    <option value="Tirunelveli">திருநெல்வேலி - Tirunelveli</option>
    <option value="Tirupattur">திருப்பத்தூர் - Thirupattur</option>
    <option value="Tiruppur">திருப்பூர் - Tiruppur</option>
    <option value="Tiruvallur">திருவள்ளூர் - Tiruvallur</option>
    <option value="Tiruvannamalai">திருவண்ணாமலை - Tiruvannamalai</option>
    <option value="Tiruvarur">திருவாரூர் - Tiruvarur</option>
    <option value="Vellore">வேலூர் - Vellore</option>
    <option value="Viluppuram">விழுப்புரம் - Viluppuram</option>
    <option value="Virudhunagar">விருதுநகர் - Virudhunagar</option>
</select>

  <div id="box"><canvas id="canvas"></canvas></div>

  <div class="controls">
    <button id="clearBtn" class="danger">Clear Signature</button>
    <div style="position:relative;display:inline-block">
      <button id="pdfMenuBtn">Preview / Download PDF ▾</button>
      <div id="pdfMenu" style="display:none;position:absolute;left:0;top:44px;background:#fff;padding:8px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.12)">
        <button id="previewBtn" style="width:200px;margin:6px;background:#444;color:#fff">Preview PDF</button><br/>
        <button id="downloadBtn" style="width:200px;margin:6px;background:#555;color:#fff">Download PDF</button>
      </div>
    </div>
    <button id="submitBtn" class="green">Submit Details</button>
  </div>

  <div class="counterRow" style="margin-top:16px">
    <div class="counter">Signatures: <strong id="sigCount">—</strong></div>
    <div class="counter">Emails sent: <strong id="mailCount">—</strong></div>
  </div>

  <div class="small" style="margin-top:12px">DYFI - தமிழ்நாடு மாநிலக்குழு</div>
</div>

<div id="msg" class="message-box"><div class="message-content"><p id="msgText"></p><button id="msgOk">OK</button></div></div>

<script>
/* ----------------------------- Firebase config ----------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBLyf_dz6xPC9wdthZSVtpatkc8JgFhE4Q",
  authDomain: "chatbox-chats.firebaseapp.com",
  databaseURL: "https://chatbox-chats-default-rtdb.firebaseio.com",
  projectId: "chatbox-chats",
  storageBucket: "chatbox-chats.appspot.com",
  messagingSenderId: "10200860576",
  appId: "1:10200860576:android:262315d86f6d1732ddc6c5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

/* ----------------------------- UI refs ----------------------------- */
const canvas = document.getElementById('canvas');
const box = document.getElementById('box');
const clearBtn = document.getElementById('clearBtn');
const pdfMenuBtn = document.getElementById('pdfMenuBtn');
const pdfMenu = document.getElementById('pdfMenu');
const previewBtn = document.getElementById('previewBtn');
const downloadBtn = document.getElementById('downloadBtn');
const submitBtn = document.getElementById('submitBtn');
const sigCountEl = document.getElementById('sigCount');
const mailCountEl = document.getElementById('mailCount');
const msg = document.getElementById('msg');
const msgText = document.getElementById('msgText');
const msgOk = document.getElementById('msgOk');

function showMessage(text){
  msgText.innerHTML = text;
  msg.classList.add('active');
  msg.style.visibility = 'visible';
  msg.style.opacity = '1';
}
msgOk.onclick = ()=> { msg.classList.remove('active'); msg.style.visibility='hidden'; msg.style.opacity='0'; };

/* ----------------------------- Canvas + SignaturePad ----------------------------- */
let signaturePad;
function setupCanvas(){
  const ratio = Math.max(window.devicePixelRatio || 1, 1);
  canvas.width = box.clientWidth * ratio;
  canvas.height = box.clientHeight * ratio;
  canvas.getContext('2d').scale(ratio, ratio);
  if(!signaturePad) signaturePad = new SignaturePad(canvas, { backgroundColor:'transparent', penColor:'blue', minWidth:1.2, maxWidth:3 });
}
window.addEventListener('resize', ()=> { setupCanvas(); });
setupCanvas();

clearBtn.onclick = ()=> signaturePad.clear();

/* ----------------------------- helper: load image as dataURL ----------------------------- */
// Essential for loading external images (like the logo/watermark) asynchronously
async function loadImageDataURL(url){
  const resp = await fetch(url);
  const blob = await resp.blob();
  return await new Promise((res, rej)=>{
    const reader = new FileReader();
    reader.onload = ()=> res(reader.result);
    reader.onerror = rej;
    reader.readAsDataURL(blob);
  });
}

/* ----------------------------- PDF creation (returns blob) - CORRECTED FOR ENGLISH/PLACEMENT ----------------------------- */
async function createPDFBlob(){
  const { jsPDF } = window.jspdf;
  
  const pdf = new jsPDF('portrait','pt','a4'); 
  const pdfW = pdf.internal.pageSize.getWidth();
  const pdfH = pdf.internal.pageSize.getHeight();
  
  const name = (document.getElementById('name').value||'').trim() || 'Unsigned User';
  const selectedDistrict = document.getElementById('district');
  const districtNameFull = selectedDistrict.options[selectedDistrict.selectedIndex].text.trim() || 'Not selected';
  
  // *** KEY CHANGE 1: Extract English name from District option ***
  // Find the last hyphen and take the part after it (e.g., "அரியலூர் - Ariyalur" -> "Ariyalur")
  let districtNameEnglish = selectedDistrict.value || 'Not selected';
  const lastHyphenIndex = districtNameFull.lastIndexOf('-');
  if (lastHyphenIndex !== -1) {
    districtNameEnglish = districtNameFull.substring(lastHyphenIndex + 1).trim() || selectedDistrict.value;
  }
  
  const number = (document.getElementById('number').value||'');

  // Replaced Tamil text with English placeholders/translations for standard font compatibility
  const headerText = ' DYFI — TNPSC Signature Campaign';
  const petitionTextRaw = "Will the lives of Tamil Nadu's youth be uplifted? Demanding the filling of 1 Lakh vacant TNPSC posts before the assembly elections, DYFI is organizing a one-day waiting protest across Tamil Nadu on December 1st.";
  const contentEnglish = `DYFI Signature Campaign demanding the filling of 1 Lakh vacant posts through TNPSC exams. Show your support. ${petitionTextRaw.replace(/\s{2,}/g, ' ').trim()}`;

  // Load background/logo image
  const bgUrl = 'https://tndyfi.github.io/Signature/images/previews.png';
  let bgDataUrl = null;
  
  try{ bgDataUrl = await loadImageDataURL(bgUrl); } catch(e) { console.warn('Background load failed', e); }

  // 1. Watermark and Background
  if(bgDataUrl){
    pdf.addImage(bgDataUrl, 'PNG', 0, 0, pdfW, pdfH);
    // Overlay semi-transparent white wash
    pdf.setFillColor(255,255,255);
    pdf.setAlpha && pdf.setAlpha(0.85);
    try{ pdf.rect(0,0,pdfW,pdfH,'F'); }catch(e){}
    pdf.setAlpha && pdf.setAlpha(1);
  }

  // 2. Header and Divider
  if(bgDataUrl){
    pdf.addImage(bgDataUrl, 'PNG', 40, 30, 70, 70); // Logo
  }

  pdf.setFont('helvetica');
  pdf.setFontSize(18);
  pdf.setTextColor(10,10,10);
  pdf.text('Democratic Youth Federation of India — Tamil Nadu', 120, 52);
  
  pdf.setFontSize(12);
  pdf.setFont('helvetica', 'normal');
  pdf.text(headerText, 120, 70);

  // Divider
  pdf.setDrawColor(200);
  pdf.setLineWidth(0.6);
  pdf.line(40, 105, pdfW-40, 105);

  // 3. Petition Content (English/Placeholder)
  pdf.setFontSize(14);
  pdf.setFont('times', 'bold');
  pdf.text('TNPSC — 1 Lakh Vacancies: Signature Campaign', 40, 130);
 
  // Content text wrapping
  pdf.setFontSize(11);
  pdf.setFont('times', 'normal');
  
  const split = pdf.splitTextToSize(contentEnglish, pdfW - 80);
  let cursorY = 155;
  pdf.text(split, 40, cursorY);
  cursorY += split.length * 14 + 10;
  
  // 4. User Details
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(12);
  
  // Use English only for PDF generation to ensure rendering works
  pdf.text(`Name: ${name}`, 40, cursorY);
  pdf.text(`Phone: ${number}`, 40, cursorY + 18);
  pdf.text(`District: ${districtNameEnglish}`, 40, cursorY + 36); 
  pdf.text(`Date: ${new Date().toLocaleString()}`, 40, cursorY + 54);

  // 5. Signature Placement - MOVED TO BOTTOM RIGHT
  if(!signaturePad.isEmpty()){
    const dataUrl = signaturePad.toDataURL('image/png');
    const img = new Image();
    img.src = dataUrl;
    await new Promise(r => img.onload = r); // Ensure image is fully loaded

    const sigW = 180; // slightly smaller width
    const sigH = (img.height / img.width) * sigW;
    const paddingX = 40;
    const paddingY = 90;
    
    // Calculate X and Y coordinates for the bottom right
    const sigX = pdfW - sigW - paddingX; 
    const sigY = pdfH - sigH - paddingY;
    
    // Add signature image
    pdf.addImage(dataUrl, 'PNG', sigX, sigY, sigW, sigH);
    
    // Set text alignment to right for elements under the signature
    pdf.setFontSize(16);
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(10, 10, 10);
    
  
  //----- Use .text(..., 'right') alignment
    const textX = pdfW - paddingX;
    let textY = sigY + sigH + 10;

    pdf.text(`${name}`, textX, textY, { align: 'right' });
    textY += 18;
    
    // Display the English part of the district name
    pdf.text(`${districtNameEnglish}`, textX, textY, { align: 'right' }); 
    textY += 18;

    pdf.text(`Signed on ${new Date().toLocaleDateString()}`, textX, textY, { align: 'right' });
    
  } else {
    // Message if signature is empty
    pdf.setFont('helvetica', 'italic');
    pdf.setFontSize(12);
    pdf.text('No signature provided', pdfW - 220, pdfH - 120);
  }

  // 6. Footer
  pdf.setFontSize(9);
  pdf.setTextColor(100);
  pdf.setFont('helvetica', 'normal'); 
  pdf.text('DYFI - Tamil Nadu', 50, pdfH - 50);
  pdf.text('contact: +919597612301,+918220554826,+919884512215. ', 30, pdfH - 30);

  // Return the PDF as a Blob
  return pdf.output('blob');
}

/* ----------------------------- PDF Menu UI ----------------------------- */
pdfMenuBtn.onclick = ()=> { pdfMenu.style.display = pdfMenu.style.display === 'block' ? 'none' : 'block'; };

previewBtn.onclick = async ()=>{
  if(signaturePad.isEmpty()){ showMessage('Please sign before previewing.'); return; }
  showMessage('Generating preview...');
  try{
    const blob = await createPDFBlob();
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank');
  }catch(e){
    console.error(e);
    showMessage('Preview failed: '+(e.message||e));
  }finally{ 
    msg.classList.remove('active'); 
    msg.style.visibility='hidden'; 
    msg.style.opacity='0'; 
    pdfMenu.style.display='none'; 
  }
};

downloadBtn.onclick = async ()=>{
  if(signaturePad.isEmpty()){ showMessage('Please sign before download.'); return; }
  showMessage('Generating download...');
  try{
    const blob = await createPDFBlob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `DYFI_Letterhead_${new Date().toISOString().slice(0,10)}.pdf`;
    a.click();
  }catch(e){
    console.error(e);
    showMessage('Download failed: '+(e.message||e));
  }finally{ 
    msg.classList.remove('active'); 
    msg.style.visibility='hidden'; 
    msg.style.opacity='0';
    pdfMenu.style.display='none'; 
  }
};

/* ----------------------------- Firebase counters ----------------------------- */
const sigCountRef = db.ref('signature_count');
const mailCountRef = db.ref('email_count');

// Ensure live counts are robustly updated
sigCountRef.on('value', snap => { sigCountEl.innerText = snap.exists() ? snap.val() : 0; });
mailCountRef.on('value', snap => { mailCountEl.innerText = snap.exists() ? snap.val() : 0; });

/* ----------------------------- Submit flow ----------------------------- */
const WEB3_KEY = 'beeb8690-8cbb-464e-ad6d-87d3b6537a03'; // your Web3Forms key

submitBtn.onclick = async ()=>{
  const name = (document.getElementById('name').value||'').trim();
  const number = (document.getElementById('number').value||'').trim();
  const district = (document.getElementById('district').value||'').trim();
  if(!name) { showMessage('Enter your name'); return; }
  if(!number) { showMessage('Enter phone number'); return; }
  if(!district) { showMessage('Select district'); return; }
  if(signaturePad.isEmpty()){ showMessage('Please sign before submitting'); return; }

  submitBtn.disabled = true;
  submitBtn.innerText = 'Submitting...';

  try{
    // 1) Upload signature image to Firebase Storage
    const dataUrl = signaturePad.toDataURL('image/png');
    const blob = await (await fetch(dataUrl)).blob();
    const ts = Date.now();
    const path = `signatures/sign_${ts}.png`;
    const ref = storage.ref().child(path);
    await ref.put(blob);
    const downloadURL = await ref.getDownloadURL();

    // 2) Save full record under signatures/
    const pushRef = db.ref('signatures').push();
    const record = {
      name, number, district, signatureURL: downloadURL, createdAt: firebase.database.ServerValue.TIMESTAMP
    };
    await pushRef.set(record);

    // 3) Increment signature count
    await sigCountRef.transaction(current => (current || 0) + 1);

    // 4) Send email via Web3Forms with link (NOT attachment)
    const form = new FormData();
    form.append('access_key', WEB3_KEY);
    form.append('subject', `DYFI Signature — ${name}`);
    form.append('name', name);
    form.append('phone', number);
    form.append('district', district);
    form.append('message', `New signature submitted. Download: ${downloadURL}`);
    form.append('redirect', 'https://web3forms.com/success');

    const resp = await fetch('https://api.web3forms.com/submit', { method:'POST', body: form });
    const json = await resp.json();
    if(json.success){
      // increment mail count
      await mailCountRef.transaction(current => (current || 0) + 1);
      showMessage('Submitted successfully — email sent!');
      // clear form
      document.getElementById('name').value = '';
      document.getElementById('number').value = '';
      document.getElementById('district').value = '';
      signaturePad.clear();
    } else {
      showMessage('Saved, but email failed: ' + (json.message || 'unknown'));
    }
  } catch(err){
    console.error(err);
    showMessage('Submission failed: ' + (err.message || err));
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerText = 'Submit Details';
  }
};
</script>
</body>
</html>
